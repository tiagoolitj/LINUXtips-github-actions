name: "NÃ­vel 1: Basic CI"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  CHALLENGE_LEVEL: 1
  CHALLENGE_NAME: "first-steps"

jobs:
  basic-setup:
    name: "Setup & Basic Checks"
    runs-on: ubuntu-latest
    
    outputs:
      node-version: ${{ steps.setup.outputs.node-version }}
      challenge-status: ${{ steps.challenge.outputs.status }}
    
    steps:
      - name: "Checkout do cÃ³digo"
        uses: actions/checkout@v4
        
      - name: "Setup Node.js"
        id: setup
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: "InformaÃ§Ãµes do ambiente"
        run: |
          echo "Runner: ${{ runner.os }}"
          echo "Node.js: $(node --version)"
          echo "NPM: $(npm --version)"
          echo "Challenge: ${{ env.CHALLENGE_NAME }}"
          echo "Data: $(date)"
          
      - name: "Instalar dependÃªncias"
        run: |
          echo "Instalando dependÃªncias..."
          npm ci
          echo "DependÃªncias instaladas com sucesso!"
          
      - name: "Verificar estrutura do projeto"
        run: |
          echo "Verificando estrutura do projeto..."
          ls -la
          echo ""
          echo "Arquivos principais encontrados:"
          [ -f "package.json" ] && echo "package.json"
          [ -f "server.js" ] && echo "server.js"
          [ -f "server.test.js" ] && echo "server.test.js"
          [ -d "public" ] && echo "diretÃ³rio public/"
          [ -d ".github/workflows" ] && echo "workflows configurados"
          
      - name: "Challenge Status"
        id: challenge
        run: |
          echo "ParabÃ©ns! VocÃª executou seu primeiro GitHub Action!"
          echo "Status: INICIADO"
          echo "PrÃ³ximo passo: Execute os testes automatizados"
          echo "status=started" >> $GITHUB_OUTPUT
          
  build:
    name: "Build da AplicaÃ§Ã£o"
    runs-on: ubuntu-latest
    needs: basic-setup
    
    steps:
      - name: "Checkout do cÃ³digo"
        uses: actions/checkout@v4
        
      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.basic-setup.outputs.node-version }}
          cache: 'npm'
          
      - name: "Instalar dependÃªncias"
        run: npm ci
        
      - name: "Build da aplicaÃ§Ã£o"
        run: |
          echo "Iniciando build..."
          npm run build
          echo "Build concluÃ­do com sucesso!"
          
      - name: "EstatÃ­sticas do build"
        run: |
          echo "EstatÃ­sticas do build:"
          echo "Tamanho do projeto: $(du -sh . | cut -f1)"
          echo "Arquivos: $(find . -type f | wc -l)"
          
  health-check:
    name: "Health Check"
    runs-on: ubuntu-latest
    needs: [basic-setup, build]
    
    steps:
      - name: "Checkout do cÃ³digo"
        uses: actions/checkout@v4
        
      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: "Instalar dependÃªncias"
        run: npm ci
        
      - name: "Iniciar servidor em background"
        run: |
          echo "Iniciando servidor..."
          npm start &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          sleep 10
          
      - name: "Verificar health endpoint"
        run: |
          echo "Verificando health check..."
          curl -f http://localhost:3000/health || exit 1
          echo "Health check passou!"
          
      - name: "Parar servidor"
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi
          
  challenge-complete:
    name: "Desafio NÃ­vel 1 - ConcluÃ­do!"
    runs-on: ubuntu-latest
    needs: [basic-setup, build, health-check]
    if: success()
    
    steps:
      - name: "ParabÃ©ns!"
        run: |
          echo "PARABÃ‰NS! VocÃª concluiu o NÃ­vel 1!"
          echo ""
          echo "O que vocÃª aprendeu:"
          echo "   â€¢ Como criar um workflow bÃ¡sico"
          echo "   â€¢ Usar actions do marketplace (checkout, setup-node)"
          echo "   â€¢ Definir jobs e steps"
          echo "   â€¢ Usar variÃ¡veis de ambiente"
          echo "   â€¢ Fazer build e health check"
          echo ""
          echo "Badge desbloqueado: First Steps ðŸš€"
          echo "PrÃ³ximo desafio: NÃ­vel 2 - Testing Master"
          echo ""
          echo "Veja seu progresso em: https://github.com/${{ github.repository }}/actions"
          
      - name: "Atualizar estatÃ­sticas"
        run: |
          echo "Atualizando estatÃ­sticas do desafio..."
          echo "Challenge: ${{ env.CHALLENGE_NAME }}"
          echo "Status: CONCLUÃDO"
          echo "Data: $(date)"
          echo "UsuÃ¡rio: ${{ github.actor }}"
          
      - name: "Gerar certificado"
        run: |
          mkdir -p certificates
          cat > certificates/level-1-certificate.md << EOF
          # Certificado de ConclusÃ£o - NÃ­vel 1
          
          **Descomplicando Github Actions - GitHub Actions Edition**
          
          ---
          
          Este certificado atesta que **${{ github.actor }}** concluiu com sucesso:
          
          ## NÃ­vel 1: Primeiro Contato
          
          **CompetÃªncias desenvolvidas:**
          - ConfiguraÃ§Ã£o de workflow bÃ¡sico
          - Uso de actions do marketplace
          - DefiniÃ§Ã£o de jobs e steps
          - VariÃ¡veis de ambiente
          - Build e health check automatizados
          
          **Data de conclusÃ£o:** $(date)
          **RepositÃ³rio:** ${{ github.repository }}
          **Workflow:** ${{ github.run_id }}
          
          ---
          
          **Badge conquistado:** First Steps
          
          **PrÃ³ximo desafio:** NÃ­vel 2 - Testing Master
          
          ---
          
          *Certificado gerado automaticamente pelo GitHub Actions*
          *LINUXtips*
          EOF
          
      - name: "Upload do certificado"
        uses: actions/upload-artifact@v4
        with:
          name: level-1-certificate
          path: certificates/
          retention-days: 30
          
      - name: "Notificar aplicaÃ§Ã£o sobre conclusÃ£o"
        run: |
          echo "Notificando aplicaÃ§Ã£o sobre a conclusÃ£o do workflow..."
          
          # Tentar notificar a aplicaÃ§Ã£o local (se estiver rodando)
          curl -X POST "http://localhost:3000/api/workflow-complete" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "${{ github.actor }}",
              "repository": "${{ github.event.repository.name }}",
              "workflowName": "${{ github.workflow }}",
              "runId": "${{ github.run_id }}",
              "certificateGenerated": true
            }' || echo "AplicaÃ§Ã£o local nÃ£o encontrada (normal em ambiente de produÃ§Ã£o)"
          
          echo "Workflow concluÃ­do com sucesso!"
          echo "Badge serÃ¡ desbloqueado automaticamente se a aplicaÃ§Ã£o estiver rodando"

